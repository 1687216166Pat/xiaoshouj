<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iOS 终极适配 v15.6 (修复运行版)</title>
    
    <!-- ✅ 修复点1：我已经帮你把钥匙换成了你现在的4个文件 -->
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="apps.css">
    <link rel="stylesheet" href="modals.css">
   
<style>
  /* ========= 1. 桌面优雅化：让预览像真机（不会撑满整个窗口） ========= */
  body {
    margin: 0;
    padding: 0;
    background: #1a1a1a;         /* 深色背景，突出手机框 */
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .iphone-screen {
    width: 100%;
    max-width: 390px;            /* 典型 iPhone 宽度，可自己改 */
    height: 100vh;
    max-height: 844px;          /* 典型 iPhone 高度，不限制也可 */
    background: var(--bg-body, #fff);
    border-radius: 40px 40px 0 0; /* 桌面圆润，手机上会取消 */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  /* 手机上：去掉圆角、阴影，占满全宽 */
  @media (max-width: 480px) {
    .iphone-screen {
      max-width: 100%;
      max-height: none;
      border-radius: 0;
      box-shadow: none;
    }
    body {
      background: black;        /* 手机 OLED 黑边效果（可选） */
    }
  }

  /* ========= 2. 核心分页修复（缩放永不露馅） ========= */
  .pages-container {
    display: flex;
    flex: 1;
    overflow-x: auto !important;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    width: 100%;
  }

  .pages-container::-webkit-scrollbar {
    display: none;
  }

  .page {
    flex: 0 0 100% !important;
    width: 100% !important;
    scroll-snap-align: start;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    box-sizing: border-box;
  }

  .page-indicators,
  .dock {
    flex-shrink: 0;
  }

  .page img {
    max-width: 100%;
    height: auto;
  }

  /* ========= 3. 可选：移除空白第一页（你代码里有个空的 .page-1）========= */
  .page-1 {
    display: none;  /* 直接隐藏，不需要删HTML */
  }
  /* 对应的第一个指示点也隐藏，并让第二个点变成 active 状态 */
  #dot-1 {
    display: none;
  }
  #dot-2 {
    background: #333;  /* 让当前激活的点变成深色（你自己原来有 .active 类，这里只是保险） */
  }
</style>
</head>
<body>

<div class="iphone-screen" id="iphone">
    <!-- 状态栏 -->
    <div class="status-bar">
        <div class="sb-left" id="sb-time">12:00</div>
        <div class="sb-right">
            <div class="sb-signal">
                <div class="bar active" style="height:40%"></div>
                <div class="bar active" style="height:60%"></div>
                <div class="bar active" style="height:80%"></div>
                <div class="bar active" style="height:100%"></div>
            </div>
            <div class="sb-wifi">
                <svg viewBox="0 0 24 24">
                    <path d="M12,4.5c4.5,0,8.6,1.8,11.5,4.7l-2.1,2.5c-2.4-2.4-5.7-3.9-9.4-3.9s-7,1.5-9.4,3.9L0.5,9.2 C3.4,6.3,7.5,4.5,12,4.5z M12,10.5c2.7,0,5.2,1.1,6.9,2.8l-2.1,2.5c-1.2-1.2-2.9-1.9-4.8-1.9s-3.6,0.7-4.8,1.9L5.1,13.3 C6.8,11.6,9.3,10.5,12,10.5z M12,16.5c0.9,0,1.8,0.4,2.4,1l-2.4,2.9l-2.4-2.9C10.2,16.9,11.1,16.5,12,16.5z"/>
                </svg>
            </div>
            <div class="sb-battery">
                <div class="sb-bat-level" id="sb-bat-level" style="width:100%"></div>
            </div>
        </div>
    </div>

    <!-- 分页容器 -->
    <div class="pages-container" id="pagesContainer">
        <!-- 第1页 -->
        <div class="page page-1"></div>

        <!-- 第2页：主页 -->
        <div class="page page-2" id="pageMain">
            <div class="top-widgets">
                <div class="anniversary-widget">
                    <div class="anni-content">
                        <div class="anni-title">恋爱纪念日</div>
                        <div class="anni-days" id="anni-days">365</div>
                        <div class="anni-date">Days Together</div>
                    </div>
                </div>
                <div class="weather-widget" id="weather-widget">
                    <div class="weather-left">
                        <div class="weather-temp" id="w-temp">--°</div>
                        <div class="weather-desc" id="w-desc">点击刷新</div>
                    </div>
                    <div class="weather-right">
                        <div class="weather-city" id="w-city">定位中...</div>
                    </div>
                </div>
            </div>
            <div class="info-banner">
                <div class="icon-box">
                    <img id="info-banner-img" src="https://images.unsplash.com/photo-1490730141103-6cac27aaab94?w=100" style="width:100%;height:100%;object-fit:cover">
                </div>
                <div class="text-area">
                    <div style="font-weight:bold;">今日箴言</div>
                    <div style="font-size:13px;opacity:0.8">保持热爱，共赴山海。</div>
                </div>
            </div>
            
            <!-- 尺子立牌组件 -->
            <div class="ruler-widget-container">
                <div class="ruler-track" id="rulerTrack">
                    <div class="badge-stand" id="badgeStand">
                        <div class="stand-bubble" id="standBubble">我爱你</div>
                        <div class="badge-circle">
                            <img id="badge-img" src="https://images.unsplash.com/photo-1529156069898-49953e39b3ac?auto=format&fit=crop&w=100&q=80" style="width:100%;height:100%;object-fit:cover">
                        </div>
                        <div class="badge-base"></div>
                    </div>
                </div>
            </div>
            
            <!-- App 图标网格 -->
            
        </div>

        <!-- 第3页：App 库 -->
        <div class="page page-3">
            <div class="app-grid" id="appGrid">
                <div class="app-item" onclick="openApp('forum')">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/8661cc78bmad154465534c811c4902ec.png">
                    </div>
                    <div class="app-label">论坛</div>
                </div>
                <div class="app-item" onclick="openApp('worldbook')">
                    <div class="app-icon">
                        <img src="http://raw.githubusercontent.com/1687216166Pat/photo/main/07355bf0dkfec500cf76ca11ba833f47.png">
                    </div>
                    <div class="app-label">世界书</div>
                </div>
                <div class="app-item">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/9258014d3n318cd2fbc760346c738a9d.png">
                    </div>
                    <div class="app-label">日记</div>
                </div>
                <div class="app-item">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/6c527e82bqd2840cdce878437c9e3948.png">
                    </div>
                    <div class="app-label">查手机</div>
                </div>
                <div class="app-item">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/4782d731dk264d611f2133cff36d09e5.png">
                    </div>
                    <div class="app-label">番茄钟</div>
                </div>
                <div class="app-item">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/7d3f66a8bt67b89310eb968d852c95c3.png">
                    </div>
                    <div class="app-label">打卡</div>
                </div>
                <div class="app-item">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/349d11dceh2778a36596296a6cf0b47a.png">
                    </div>
                    <div class="app-label">纪念日</div>
                </div>
                <div class="app-item" onclick="openApp('sms')">
                    <div class="app-icon">
                        <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/0919010c0ufaa60e76b9f8845cb7c6c3.png">
                    </div>
                    <div class="app-label">信息</div>
                    <div class="app-badge" id="sms-badge">1</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页面指示点 -->
    <div class="page-indicators">
        <div class="page-dot" id="dot-1"></div>
        <div class="page-dot active" id="dot-2"></div>
        <div class="page-dot" id="dot-3"></div>
    </div>

    <!-- Dock栏 -->
        <!-- Dock栏 (已修改) -->
    <div class="dock">
        <!-- 第1个：Talk -->
        <div class="app-item" onclick="openApp('messenger')">
            <div class="app-icon">
                <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/a27d8264fv991e8df1dbeb536e03d280.png">
            </div>
        </div>

        <!-- 第2个：设置 -->
        <div class="app-item" onclick="openApp('settings')">
            <div class="app-icon">
                <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/f9d3f4da6rcb3778c460a508f774d0c0.png">
            </div>
        </div>

        <!-- 第3个：电话 (✅ 已修复：加上了点击事件) -->
        <div class="app-item" onclick="openApp('phone')">
            <div class="app-icon">
                <img src="https://raw.githubusercontent.com/1687216166Pat/photo/main/bf7367681vd2aa91567d4c09c2f033ce.png">
            </div>
        </div>
    </div>

</div>
    </div>

    <!-- 设置 App -->
    <div class="app-overlay" id="settingsApp">
        <div class="header">
            <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
            <div class="header-title">设置</div>
            <div style="width:60px"></div>
        </div>
        <div class="ios-list-container">
            <div class="ios-group-card">
                <div class="list-row">
                    <div style="flex:1">通用</div>
                    <div style="color:var(--text-secondary)">〉</div>
                </div>
                <div class="list-row" onclick="showLayer('display-settings-layer')">
                    <div style="width:28px;text-align:center;margin-right:10px;font-size:18px;background:#007aff;color:white;border-radius:6px;height:28px;line-height:28px">Aa</div>
                    <div style="flex:1">显示与亮度</div>
                    <div style="color:var(--text-secondary)">〉</div>
                </div>
                <div class="list-row" onclick="openBeautify()">
                    <div style="flex:1">美化</div>
                    <div style="color:var(--text-secondary)">〉</div>
                </div>
            </div>
            <div class="ios-group-card">
                <div class="list-row" onclick="showLayer('api-settings-layer')">
                    <div style="flex:1">API 预设</div>
                    <div style="color:var(--text-secondary)">〉</div>
                </div>
            </div>
        </div>

        <!-- 显示与亮度设置页 -->
        <div class="chat-full-layer" id="display-settings-layer">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('display-settings-layer')">‹ 设置</button>
                <div class="header-title">显示与亮度</div>
                <div style="width:60px"></div>
            </div>
            <div class="ios-list-container">
                <div class="ios-group-card">
                    <div class="appearance-selector">
                        <div class="mode-option" onclick="setAppearanceMode('light')">
                            <div class="preview-card light">
                                <div class="preview-ui-mock" style="width:40%;height:4px;margin-top:10px"></div>
                                <div class="preview-ui-mock" style="width:80%;height:30px;border-radius:6px;margin-top:5px"></div>
                                <div class="preview-ui-mock" style="width:80%;height:15px;border-radius:6px;margin-top:5px"></div>
                            </div>
                            <span class="mode-label">浅色</span>
                            <div class="radio-circle" id="radio-light"></div>
                        </div>
                        <div class="mode-option" onclick="setAppearanceMode('dark')">
                            <div class="preview-card dark">
                                <div class="preview-ui-mock" style="width:40%;height:4px;margin-top:10px"></div>
                                <div class="preview-ui-mock" style="width:80%;height:30px;border-radius:6px;margin-top:5px"></div>
                                <div class="preview-ui-mock" style="width:80%;height:15px;border-radius:6px;margin-top:5px"></div>
                            </div>
                            <span class="mode-label">深色</span>
                            <div class="radio-circle" id="radio-dark"></div>
                        </div>
                    </div>
                    <div class="list-row" style="padding:15px">
                        <span style="flex:1">自动</span>
                        <label class="ios-switch">
                            <input type="checkbox" id="auto-mode-toggle" onchange="toggleAutoMode()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="list-row" id="auto-options-row" onclick="showLayer('display-options-layer')" style="display:none">
                        <div style="flex:1">选项</div>
                        <div style="color:var(--text-secondary);margin-right:5px" id="current-schedule-desc">日落到日出</div>
                        <div style="color:var(--text-secondary)">〉</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 自动外观选项页 -->
        <div class="chat-full-layer" id="display-options-layer">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('display-options-layer')">‹ 返回</button>
                <div class="header-title">外观计划</div>
                <div style="width:60px"></div>
            </div>
            <div style="padding:20px 15px">
                <div class="option-desc">设定时间让外观自动。iphone可能会等到你不使用屏幕时才执行外观切换。</div>
                <div class="ios-group-card">
                    <div class="list-row" onclick="setScheduleType('sunset')">
                        <div style="flex:1">日落到日出</div>
                        <div class="radio-circle" id="sched-sunset" style="border:none"></div>
                    </div>
                    <div class="list-row" onclick="setScheduleType('custom')">
                        <div style="flex:1">自定义时段</div>
                        <div class="radio-circle" id="sched-custom" style="border:none"></div>
                    </div>
                </div>
                <!-- 自定义时段选择区域 (已修复：可以自由选择时间) -->
<div class="ios-group-card" id="custom-time-picker" style="display:none">
    <div class="list-row">
        <div style="flex:1">浅色外观</div>
        <!-- 👇 这里换成了 input type="time"，可以点开选时间了 -->
        <input type="time" class="time-picker-input" id="time-light" value="07:00">
    </div>
    <div class="list-row">
        <div style="flex:1">深色外观</div>
        <!-- 👇 这里也换成了 input type="time" -->
        <input type="time" class="time-picker-input" id="time-dark" value="22:00">
    </div>
</div>

            </div>
        </div>

        <!-- API 设置页 -->
        <div class="chat-full-layer" id="api-settings-layer">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('api-settings-layer')">取消</button>
                <div class="header-title">配置 API</div>
                <button class="header-btn" onclick="hideLayer('api-settings-layer')" style="font-weight:bold">完成</button>
            </div>
            <div style="padding:20px 15px;overflow-y:auto">
                <div class="form-group">
                    <div class="form-label-row">API 供应商</div>
                    <select class="form-select-box" id="api-provider" onchange="checkApiProvider()">
                        <option value="custom">自定义 / NewAPI</option>
                        <option value="openai">OpenAI (官方)</option>
                    </select>
                    <div style="margin-top:10px">
                        <div class="form-label-row">URL 地址</div>
                        <input type="text" id="custom-url" class="form-input-box" placeholder="https://api.example.com/v1" onblur="autoFixUrl(this)">
                    </div>
                    <div class="form-label-row">密钥 (Key)</div>
                    <input type="password" id="api-key" class="form-input-box" placeholder="sk-...">
                    <div class="form-label-row" style="margin-top:5px; height:31px;">
                        <span style="flex:1; line-height:1.4;">CORS 代理</span>
                        <label class="ios-switch">
                            <input type="checkbox" id="cors-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-label-row" style="margin-top:15px">
                        <span>模型调用</span>
                        <div class="button-group">
                            <button class="fetch-btn" onclick="testConnection()">测试连接</button>
                            <span style="color:#ddd">|</span>
                            <button class="fetch-btn" onclick="fetchModels()">获取模型</button>
                        </div>
                    </div>
                    <input type="text" id="model-input" class="form-input-box" placeholder="gpt-3.5-turbo" style="margin-bottom:0">
                </div>
            </div>
        </div>
        
        <!-- 美化页面层 -->
        <div class="chat-full-layer" id="beautify-layer">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('beautify-layer')">返回</button>
                <div class="header-title">美化</div>
                <button class="header-btn" style="font-weight:bold" onclick="saveBeautify()">保存</button>
            </div>
            <div style="padding:20px 15px">
                <div class="form-group">
                    <div class="form-label-row" style="margin-bottom:15px;font-weight:bold">Info Banner 图标</div>
                    <div class="settings-avatar-row" style="padding:0;margin-bottom:20px">
                        <div class="avatar-uploader" onclick="document.getElementById('upload-banner').click()">
                            <img id="preview-banner" src="https://images.unsplash.com/photo-1490730141103-6cac27aaab94?w=100">
                        </div>
                        <input type="file" id="upload-banner" style="display:none" accept="image/*" onchange="handleImageUpload(this, 'preview-banner')">
                    </div>
                    <div class="form-label-row" style="margin-bottom:15px;font-weight:bold">电子徽章 (尺子)</div>
                    <div class="settings-avatar-row" style="padding:0">
                        <div class="avatar-uploader" onclick="document.getElementById('upload-badge').click()">
                            <img id="preview-badge" src="https://images.unsplash.com/photo-1529156069898-49953e39b3ac?auto=format&fit=crop&w=100&q=80">
                        </div>
                        <input type="file" id="upload-badge" style="display:none" accept="image/*" onchange="handleImageUpload(this, 'preview-badge')">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 论坛 App -->
    <div class="app-overlay" id="forumApp">
        <div class="header">
            <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
            <div class="header-title">论坛</div>
            <div style="width:60px"></div>
        </div>
        <div style="flex:1;display:flex;justify-content:center;align-items:center;color:var(--text-secondary);flex-direction:column">
            <div style="font-size:40px;margin-bottom:10px">🚧</div>
            <div>页面搭建中...</div>
        </div>
    </div>

    <!-- 信息 App -->
    <div class="app-overlay" id="smsApp">
        <div id="sms-home-view" style="width:100%;height:100%;display:flex;flex-direction:column;">
            <div class="header">
                <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
                <div class="header-title" style="font-weight:bold;font-size:20px;text-align:left;padding-left:10px">信息</div>
                <div style="width:60px"></div>
            </div>
            <div class="sms-root-list">
                <div class="ios-list-group">
                    <div class="ios-list-item" onclick="showSMSList('all')">
                        <div class="ios-list-icon">
                            <svg viewBox="0 0 24 24" width="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                        </div>
                        <div class="ios-list-label">所有信息</div>
                        <div class="ios-list-count" id="cnt-all">0</div>
                        <div class="ios-arrow">〉</div>
                    </div>
                    <div class="ios-list-item" onclick="showSMSList('known')">
                        <div class="ios-list-icon">
                            <svg viewBox="0 0 24 24" width="24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <div class="ios-list-label">已知发件人</div>
                        <div class="ios-list-count" id="cnt-known">0</div>
                        <div class="ios-arrow">〉</div>
                    </div>
                    <div class="ios-list-item" onclick="showSMSList('unknown')">
                        <div class="ios-list-icon">
                            <svg viewBox="0 0 24 24" width="24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                        </div>
                        <div class="ios-list-label">未知发件人</div>
                        <div class="ios-list-count" id="cnt-unknown">0</div>
                        <div class="ios-arrow">〉</div>
                    </div>
                    <div class="ios-list-item" onclick="showSMSList('unread')">
                        <div class="ios-list-icon">
                            <svg viewBox="0 0 24 24" width="24"><circle cx="12" cy="12" r="10"/></svg>
                        </div>
                        <div class="ios-list-label">未读信息</div>
                        <div class="ios-list-count" id="cnt-unread">0</div>
                        <div class="ios-arrow">〉</div>
                    </div>
                </div>
                <div class="ios-list-group">
                    <div class="ios-list-item" onclick="showSMSList('starred')">
                        <div class="ios-list-icon">
                            <svg viewBox="0 0 24 24" width="24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </div>
                        <div class="ios-list-label">收藏信息</div>
                        <div class="ios-list-count" id="cnt-starred">0</div>
                        <div class="ios-arrow">〉</div>
                    </div>
                </div>
                <div class="ios-list-group">
                    <div class="ios-list-item" onclick="showSMSList('deleted')">
                        <div class="ios-list-icon">
                            <svg viewBox="0 0 24 24" width="24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </div>
                        <div class="ios-list-label">最近删除</div>
                        <div class="ios-list-count" id="cnt-deleted">0</div>
                        <div class="ios-arrow">〉</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-full-layer" id="sms-sub-view" style="z-index:50">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('sms-sub-view')">‹ 列表</button>
                <div class="header-title" id="sms-list-title">所有信息</div>
                <div class="header-right-group" id="sms-list-actions"></div>
            </div>
            <div style="flex:1;overflow-y:auto" id="sms-sub-list-content"></div>
        </div>
        <div class="chat-full-layer" id="sms-chat-layer" style="z-index:60">
            <div class="sms-chat-header">
                <div class="sms-header-left">
                    <button class="header-btn" onclick="hideLayer('sms-chat-layer')" style="font-size:24px;padding-left:0;">‹</button>
                </div>
                <div class="sms-header-center">
                    <img id="sms-chat-avatar" class="sms-header-avatar" src="">
                    <div id="sms-chat-name" class="sms-header-name">Unknown</div>
                    <div class="sms-header-sub" id="sms-chat-number">10658888 〉</div>
                </div>
                <div class="sms-header-right"></div>
            </div>
            <div class="chat-content" id="sms-chat-box" style="padding-top:10px"></div>
            <div class="input-area">
                <input type="text" id="sms-input" placeholder="短信/iMessage" onkeydown="if(event.keyCode===13) sendSMS()">
                <button onclick="sendSMS()" style="color:var(--text-primary)">↑</button>
            </div>
        </div>
    </div>

    <!-- 世界书 App -->
    <div class="app-overlay" id="worldbookApp">
        <div class="header">
            <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
            <div class="header-title">📖 世界书</div>
            <div class="header-right-group">
                <button class="header-btn" style="font-size:14px" onclick="document.getElementById('wb-upload-input').click()">上传</button>
                <button class="header-btn" style="font-size:24px" onclick="openWBEdit()">+</button>
            </div>
        </div>
        <div style="padding:15px; overflow-y:auto; flex:1" id="wb-list-container"></div>
        <input type="file" id="wb-upload-input" style="display:none" onchange="alert('文件已读取 (模拟)')">
    </div>

    <!-- 世界书编辑 -->
    <div class="modal-overlay" id="wb-edit-modal">
        <div class="add-contact-card">
            <div class="card-header">
                <button class="header-btn" style="color:#999" onclick="closeWBEdit()">取消</button>
                <div class="card-title">添加世界书</div>
                <button class="header-btn" style="font-weight:bold" onclick="saveWB()">保存</button>
            </div>
            <div class="card-body">
                <div>
                    <div class="input-label">标题</div>
                    <input type="text" id="wb-title" class="input-block">
                </div>
                <div>
                    <div class="input-label">内容</div>
                    <div class="persona-block-wrapper">
                        <textarea id="wb-content" class="persona-block"></textarea>
                        <div class="expand-btn" onclick="togglePersonaExpand(true, 'wb-content')">⤢</div>
                    </div>
                </div>
                <div>
                    <div class="input-label">插入位置</div>
                    <div class="wb-pos-btn-group">
                        <div class="wb-pos-btn" id="pos-front" onclick="setWBPos('front')">前</div>
                        <div class="wb-pos-btn" id="pos-back" onclick="setWBPos('back')">后</div>
                        <div class="wb-pos-btn urgent" id="pos-highest" onclick="setWBPos('highest')">最高</div>
                    </div>
                </div>
                <div>
                    <div class="input-label">分类</div>
                    <div class="select-block" onclick="openCategorySelect()">
                        <span id="wb-category-display">默认分类</span>
                        <span>▼</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Talk (原微信) -->
    <div class="app-overlay" id="messengerApp">
        <input type="file" id="file-upload" accept=".json,.docx" style="display:none" onchange="alert('文件已选: '+this.files[0].name)">
        <div class="messenger-main">
            <div class="tab-view active" id="view-contacts">
                <div class="header">
                    <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
                    <div class="header-title">Talk</div>
                    <div class="header-right-group">
                        <svg class="header-icon" viewBox="0 0 24 24" onclick="document.getElementById('file-upload').click()">
                            <path d="M12 3L12 15M12 3L8 7M12 3L16 7M6 10V19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V10" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        <svg class="header-icon" viewBox="0 0 24 24" onclick="toggleSheet('add-menu-overlay',true)">
                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2.5"/>
                        </svg>
                    </div>
                </div>
                <div style="padding:10px 15px;background:var(--bg-card)">
                    <div style="background:var(--bg-input);padding:8px;border-radius:10px;color:var(--text-secondary);text-align:center;font-size:14px">🔍 搜索</div>
                </div>
                <div id="contacts-list-container"></div>
            </div>
            <div class="tab-view" id="view-list">
                <div class="header">
                    <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
                    <div class="header-title">朋友圈</div>
                    <div style="width:70px"></div>
                </div>
                <div style="padding:20px;text-align:center;color:var(--text-secondary)">暂无新动态</div>
            </div>
            <div class="tab-view" id="view-profile">
                <div class="header" style="border:none;background:transparent">
                    <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
                    <div class="header-title"></div>
                    <div style="width:70px"></div>
                </div>
                <div class="profile-container">
                    <div class="profile-header">
                        <img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=500" class="profile-bg">
                        <div class="profile-avatar-box">
                            <img src="https://i.pravatar.cc/150?u=me" class="profile-avatar">
                        </div>
                    </div>
                    <div style="padding:10px 20px 20px;">
                        <div style="font-size:24px;font-weight:bold">Admin</div>
                    </div>
                </div>
            </div>
            <div class="tab-bar">
                <div class="tab-item active" onclick="switchTab('contacts', event)">
                    <div style="font-size:24px">💬</div>
                    <div style="font-size:10px">Talk</div>
                </div>
                <div class="tab-item" onclick="switchTab('list', event)">
                    <div style="font-size:24px">⭕️</div>
                    <div style="font-size:10px">朋友圈</div>
                </div>
                <div class="tab-item" onclick="switchTab('profile', event)">
                    <div style="font-size:24px">👤</div>
                    <div style="font-size:10px">我</div>
                </div>
            </div>
        </div>

        <div class="chat-full-layer" id="chat-layer">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('chat-layer')">‹ Talk</button>
                <div class="header-title" id="chat-user-name">Chat</div>
                <div class="header-right-group">
                    <button class="header-btn" style="font-size:20px;color:var(--text-primary)" onclick="openChatSettings()">···</button>
                </div>
            </div>
            <div class="chat-content" id="chat-box" style="background:var(--bg-body)"></div>
            <div class="typing-indicator" id="typing-indicator">对方正在输入...</div>
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="">
                <button onclick="sendMsg()" id="send-btn" style="display:none">发送</button>
            </div>
        </div>
        <div class="chat-full-layer" id="chat-settings-layer" style="z-index:1000">
            <div class="header">
                <button class="header-btn" onclick="hideLayer('chat-settings-layer')">取消</button>
                <div class="header-title">详细设置</div>
                <button class="header-btn" style="font-weight:bold" onclick="saveChatSettings()">保存</button>
            </div>
            <div style="padding:0 15px 40px 15px; overflow-y:auto; flex:1;">
                <div class="settings-avatar-row">
                    <div class="avatar-uploader" onclick="document.getElementById('settings-avatar-input').click()">
                        <img id="settings-avatar-preview" src="">
                    </div>
                    <input type="file" id="settings-avatar-input" style="display:none" accept="image/*" onchange="previewSettingsAvatar(this)">
                </div>
                <div class="input-label">名称</div>
                <input type="text" id="settings-name" class="input-block" style="margin-bottom:15px">
                <div class="input-label">备注</div>
                <input type="text" id="settings-remark" class="input-block" style="margin-bottom:15px">
                <div class="input-label">人设</div>
                <div class="persona-block-wrapper" style="margin-bottom:15px">
                    <textarea id="settings-persona" class="persona-block"></textarea>
                    <div class="expand-btn" onclick="togglePersonaExpand(true, 'settings-persona')">⤢</div>
                </div>
                <div class="input-label">关联世界书</div>
                <div class="list-row" style="margin-bottom:15px;border-radius:12px;" onclick="openWBSelectorForChat()">
                    <div style="flex:1" id="settings-wb-count">选择世界书</div>
                    <div style="color:#ccc">〉</div>
                </div>
                <div id="settings-block-row" style="background:var(--bg-card);border-radius:12px;padding:15px;display:flex;justify-content:space-between;align-items:center;margin-bottom:25px">
                    <span>拉黑</span>
                    <label class="ios-switch">
                        <input type="checkbox" id="settings-block-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="action-btn delete-btn" onclick="deleteCurrentContact()">删除聊天对象</div>
            </div>
        </div>
        <div class="action-sheet-overlay" id="add-menu-overlay" onclick="toggleSheet('add-menu-overlay',false)">
            <div class="action-sheet" onclick="event.stopPropagation()">
                <div class="action-btn" onclick="openAddContact()">添加联系人</div>
                <div class="action-btn" onclick="openGroupCreate()">发起群聊</div>
                <div class="action-btn cancel" onclick="toggleSheet('add-menu-overlay',false)">取消</div>
            </div>
        </div>
        <div class="modal-overlay" id="add-contact-modal">
            <div class="add-contact-card">
                <div class="card-header">
                    <button class="header-btn" style="color:#999" onclick="closeAddContact()">取消</button>
                    <div class="card-title">新建联系人</div>
                    <button class="header-btn" style="font-weight:bold" onclick="saveNewContact()">完成</button>
                </div>
                <div class="card-body">
                    <div>
                        <div class="input-label">角色名称</div>
                        <input type="text" id="new-name" class="input-block" placeholder="例如：爱丽丝">
                    </div>
                    <div>
                        <div class="input-label">角色该如何称呼你</div>
                        <input type="text" id="new-nickname" class="input-block" placeholder="例如：旅行者">
                    </div>
                    <div>
                        <div class="input-label">角色人设</div>
                        <div class="persona-block-wrapper">
                            <textarea id="new-persona" class="persona-block" placeholder="输入详细的角色性格..."></textarea>
                            <div class="expand-btn" onclick="togglePersonaExpand(true, 'new-persona')">⤢</div>
                        </div>
                    </div>
                    <div>
                        <div class="input-label">关联世界书</div>
                        <div class="select-block" onclick="openWBSelectorForNew()">
                            <span id="new-wb-display">未选择</span>
                            <span style="color:#ccc;font-size:12px">▼</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-overlay" id="group-create-modal">
            <div class="add-contact-card">
                <div class="card-header">
                    <button class="header-btn" style="color:#999" onclick="closeGroupCreate()">取消</button>
                    <div class="card-title">选择群成员</div>
                    <button class="header-btn" style="font-weight:bold" onclick="createNewGroup()">创建</button>
                </div>
                <div class="card-body" id="group-select-list"></div>
            </div>
        </div>
    </div>

    <!-- 全局覆盖层 -->
    <div class="full-screen-edit" id="persona-full-layer">
        <div class="header">
            <button class="header-btn" onclick="togglePersonaExpand(false)">返回</button>
            <div class="header-title">编辑内容</div>
            <button class="header-btn" onclick="togglePersonaExpand(false)" style="font-weight:bold">确定</button>
        </div>
        <textarea id="full-persona-input" class="full-edit-area" placeholder="在这里输入详细内容..."></textarea>
    </div>
    <div class="action-sheet-overlay" id="category-select-overlay" onclick="this.classList.remove('active')" style="z-index:2200">
        <div class="action-sheet" id="category-list-content" onclick="event.stopPropagation()"></div>
    </div>
    <div class="modal-overlay" id="wb-multi-selector" style="z-index:2300">
        <div class="add-contact-card">
            <div class="card-header">
                <button class="header-btn" style="color:#ff3b30" onclick="closeWBMultiSelector()">取消</button>
                <div class="card-title">选择世界书</div>
                <button class="header-btn" style="font-weight:bold" onclick="confirmWBMultiSelection()">确定</button>
            </div>
            <div class="card-body" id="wb-multi-list"></div>
        </div>
    </div>
    <div class="action-sheet-overlay" id="model-select-overlay" onclick="toggleSheet('model-select-overlay',false)" style="z-index:2200">
        <div class="action-sheet" id="model-list-content" onclick="event.stopPropagation()"></div>
    </div>
</div>

<!-- ================= 电话 App ================= -->
<div class="app-overlay" id="phoneApp" style="background: var(--bg-body); display: flex; flex-direction: column;">
    
    <!-- ✅ 新增：公共顶部栏 (包含返回按钮) -->
    <div class="header" style="background: transparent; border: none; z-index: 10; flex-shrink: 0;">
        <button class="header-btn" onclick="closeApp()">‹ 主屏幕</button>
        <div class="header-title" id="phone-app-title">拨号键盘</div>
        <div style="width: 60px;"></div> <!-- 占位，为了让标题居中 -->
    </div>

    <!-- 1. 拨号键盘页面 (默认显示) -->
    <!-- 注意：我把这里的 height:100% 改成了 flex:1，防止被顶部栏挤出屏幕 -->
    <div id="phone-tab-keypad" class="phone-tab-content active" style="flex:1; display:flex; flex-direction:column;">
        <!-- 显示输入的数字 -->
        <div style="flex:1; display:flex; align-items:flex-end; justify-content:center; padding-bottom:20px;">
            <div id="phone-number-display" style="font-size:32px; font-weight:500; color:var(--text-primary);"></div>
        </div>
        
        <!-- 键盘区域 -->
        <div class="keypad-container">
            <div class="key-row">
                <div class="key-btn" onclick="pressKey('1')">1<div class="sub-text">&nbsp;</div></div>
                <div class="key-btn" onclick="pressKey('2')">2<div class="sub-text">ABC</div></div>
                <div class="key-btn" onclick="pressKey('3')">3<div class="sub-text">DEF</div></div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="pressKey('4')">4<div class="sub-text">GHI</div></div>
                <div class="key-btn" onclick="pressKey('5')">5<div class="sub-text">JKL</div></div>
                <div class="key-btn" onclick="pressKey('6')">6<div class="sub-text">MNO</div></div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="pressKey('7')">7<div class="sub-text">PQRS</div></div>
                <div class="key-btn" onclick="pressKey('8')">8<div class="sub-text">TUV</div></div>
                <div class="key-btn" onclick="pressKey('9')">9<div class="sub-text">WXYZ</div></div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="pressKey('*')">*</div>
                <div class="key-btn" onclick="pressKey('0')">0<div class="sub-text">+</div></div>
                <div class="key-btn" onclick="pressKey('#')">#</div>
            </div>
            <div class="key-row" style="margin-top:10px;">
                <div class="key-placeholder"></div> <!-- 占位 -->
                <div class="key-btn call-btn" onclick="makeCall()">
                    <svg viewBox="0 0 24 24" width="28" fill="white"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-2.2 2.2a15.057 15.057 0 01-6.59-6.59l2.2-2.21a.96.96 0 00.25-1.01A11.36 11.36 0 018.59 3.99C8.59 3.45 8.14 3 7.6 3H4.19C3.65 3 3 3.24 3 7.5c0 10.19 8.31 18.5 18.5 18.5 4.29 0 4.5-.65 4.5-1.19V21.4c0-.55-.45-1-1-1h-3.41c-.55 0-1.05-.45-1.08-.98z"/></svg>
                </div>
                <div class="key-btn delete-btn" onclick="deleteNumber()" style="background:transparent;">
                    <svg viewBox="0 0 24 24" width="24" fill="var(--text-secondary)"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/></svg>
                </div>
            </div>
        </div>
        <div style="height: 80px;"></div> <!-- 底部垫高 -->
    </div>

    <!-- 2. 其他页面 (暂时用占位符) -->
    <!-- 注意：这里也都加了 flex:1 -->
    <div id="phone-tab-favorites" class="phone-tab-content" style="display:none; flex:1; padding:20px; text-align:center; color:var(--text-secondary);">暂无收藏</div>
    <div id="phone-tab-recents" class="phone-tab-content" style="display:none; flex:1; padding:20px; text-align:center; color:var(--text-secondary);">最近通话记录为空</div>
    <div id="phone-tab-contacts" class="phone-tab-content" style="display:none; flex:1; padding:20px; text-align:center; color:var(--text-secondary);">通讯录为空</div>
    <div id="phone-tab-voicemail" class="phone-tab-content" style="display:none; flex:1; padding:20px; text-align:center; color:var(--text-secondary);">无语音留言</div>

    <!-- 底部 Tab 栏 -->
    <div class="phone-tab-bar">
        <div class="phone-tab-item" onclick="switchPhoneTab('favorites')">
            <div class="tab-icon">★</div>
            <div class="tab-label">个人收藏</div>
        </div>
        <div class="phone-tab-item" onclick="switchPhoneTab('recents')">
            <div class="tab-icon">🕒</div>
            <div class="tab-label">最近通话</div>
        </div>
        <div class="phone-tab-item" onclick="switchPhoneTab('contacts')">
            <div class="tab-icon">👤</div>
            <div class="tab-label">通讯录</div>
        </div>
        <div class="phone-tab-item active" onclick="switchPhoneTab('keypad')">
            <div class="tab-icon">罒</div>
            <div class="tab-label">拨号键盘</div>
        </div>
        <div class="phone-tab-item" onclick="switchPhoneTab('voicemail')">
            <div class="tab-icon">➿</div>
            <div class="tab-label">语音留言</div>
        </div>
    </div>
</div>

<!-- ================= 1. 通话中/拨出界面 (升级版) ================= -->
<!-- 注意：这里增加了 flex 布局，为了让中间的聊天记录可以滚动 -->
<div class="full-screen-edit" id="call-screen" style="background: linear-gradient(180deg, #2c3e50 0%, #000000 100%); z-index: 2000; display: none; flex-direction: column; padding-top: 60px;">
    
    <!-- A. 顶部信息 (名字和状态) -->
    <div style="text-align: center; flex-shrink: 0; margin-bottom: 20px;">
        <div style="font-size: 32px; color: white; font-weight: 500;" id="call-name">未知号码</div>
        <div style="font-size: 16px; color: rgba(255,255,255,0.6); margin-top: 5px;" id="call-status">正在呼叫...</div>
    </div>

    <!-- B. 中间核心区 (头像 / 聊天记录 / 语音信箱) -->
    <div id="call-main-area" style="flex: 1; width: 100%; overflow-y: auto; padding: 10px; display: flex; flex-direction: column;">
        
        <!-- 1. 默认头像 (呼叫时显示，接通后隐藏) -->
        <div id="call-avatar-placeholder" style="flex: 1; display: flex; align-items: center; justify-content: center;">
            <div style="width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 50px;">👤</span>
            </div>
        </div>

        <!-- 2. 文字通话列表 (接通后显示) -->
        <div id="call-chat-list" style="display: none; flex-direction: column; gap: 10px; padding-bottom: 20px;">
            <!-- 聊天气泡会自动插在这里 -->
        </div>

        <!-- 3. 语音信箱输入框 (被拒接后显示) -->
        <div id="call-voicemail-area" style="display: none; width: 100%; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;">
            <div style="color:white; margin-bottom:10px; font-size:14px;">请在“嘀”声后留言：</div>
            <textarea id="voicemail-input" style="width:100%; height:80px; background:transparent; border:none; color:white; font-size:16px; outline:none;" placeholder="输入留言内容..."></textarea>
            <button onclick="sendVoicemail()" style="width:100%; margin-top:10px; background:white; color:black; border:none; padding:8px; border-radius:8px; font-weight:bold;">发送留言</button>
        </div>
    </div>

    <!-- C. 底部操作栏 -->
    <div style="padding: 20px 30px 40px; display: flex; flex-direction: column; gap: 20px; background: rgba(0,0,0,0.3);">
        
        <!-- 文字输入框 (仅在接通时显示) -->
        <div id="call-input-bar" style="display: none; gap: 10px; align-items: center;">
            <input type="text" id="call-text-input" placeholder="输入对话..." style="flex:1; padding:10px 15px; border-radius:20px; border:none; outline:none; background: rgba(255,255,255,0.9);">
            <button onclick="sendCallMsg()" style="background:#34C759; color:white; border:none; width:40px; height:40px; border-radius:50%; font-size: 20px; display:flex; align-items:center; justify-content:center;">↑</button>
        </div>

        <!-- 挂断按钮 -->
        <div style="display: flex; justify-content: center;">
            <div onclick="endCall()" style="width: 70px; height: 70px; background: #FF3B30; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" width="32" fill="white"><path d="M12 9c-2.5 0-4.97 1.17-6.9 3.19c-.46.48-.44 1.26.06 1.72l2.25 2.06c.26.24.64.29.95.13l.16-.08c1.78-.96 2.65-2.6 2.65-4.22V10h1.66v1.8c0 1.62.87 3.26 2.65 4.22l.16.08c.31.16.69.11.95-.13l2.25-2.06c.5-.46.52-1.24.06-1.72C16.97 10.17 14.5 9 12 9z"/></svg>
            </div>
        </div>
    </div>
</div>

<!-- ================= 2. 来电界面 (新增：角色打给你) ================= -->
<div class="full-screen-edit" id="incoming-call-screen" style="background: linear-gradient(180deg, #000000 0%, #2c3e50 100%); z-index: 2100; display: none; flex-direction: column; align-items: center; justify-content: space-between; padding-top: 80px; padding-bottom: 80px;">
    
    <div style="text-align: center;">
        <div style="font-size: 18px; color: rgba(255,255,255,0.8);">移动电话</div>
        <div style="font-size: 40px; color: white; margin-top: 10px;" id="incoming-name">爱丽丝</div>
    </div>

    <div style="width: 100%; display: flex; justify-content: space-around; padding: 0 40px;">
        <!-- 拒接按钮 -->
        <div onclick="rejectIncomingCall()" style="display:flex; flex-direction:column; align-items:center; gap:10px; cursor:pointer;">
            <div style="width: 70px; height: 70px; background: #FF3B30; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" width="32" fill="white"><path d="M12 9c-2.5 0-4.97 1.17-6.9 3.19c-.46.48-.44 1.26.06 1.72l2.25 2.06c.26.24.64.29.95.13l.16-.08c1.78-.96 2.65-2.6 2.65-4.22V10h1.66v1.8c0 1.62.87 3.26 2.65 4.22l.16.08c.31.16.69.11.95-.13l2.25-2.06c.5-.46.52-1.24.06-1.72C16.97 10.17 14.5 9 12 9z"/></svg>
            </div>
            <span style="color:white; font-size:14px;">拒绝</span>
        </div>
        <!-- 接听按钮 -->
        <div onclick="acceptIncomingCall()" style="display:flex; flex-direction:column; align-items:center; gap:10px; cursor:pointer;">
            <div style="width: 70px; height: 70px; background: #34C759; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" width="32" fill="white"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-2.2 2.2a15.057 15.057 0 01-6.59-6.59l2.2-2.21a.96.96 0 00.25-1.01A11.36 11.36 0 018.59 3.99C8.59 3.45 8.14 3 7.6 3H4.19C3.65 3 3 3.24 3 7.5c0 10.19 8.31 18.5 18.5 18.5 4.29 0 4.5-.65 4.5-1.19V21.4c0-.55-.45-1-1-1h-3.41c-.55 0-1.05-.45-1.08-.98z"/></svg>
            </div>
            <span style="color:white; font-size:14px;">接听</span>
        </div>
    </div>
</div>


<!-- ✅ 修复点2：我已经帮你把JS钥匙也换对了 -->
<script src="system.js"></script>
<script src="apps.js"></script>
<script src="services.js"></script>
</body>
</html>
